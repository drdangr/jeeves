# Тематический Граф с Poincaré Embeddings: Комплексная методология

## 1. Введение и концепция

**Тематический Граф** — это структура данных для смыслового представления знаний, которая моделирует темы, подтемы и их взаимосвязи в виде направленного ациклического графа (DAG). Этот подход позволяет эффективно организовывать большие объемы информации, обеспечивать навигацию по ним и строить системы генерации текста, опирающиеся на структурированные знания.

Особенностью нашего подхода является комбинация традиционных методов векторного представления семантики (embeddings в евклидовом пространстве) с инновационными Poincaré Embeddings в гиперболическом пространстве, что позволяет одновременно моделировать:

1. **Семантическое сходство** между темами и фрагментами знаний
2. **Иерархические отношения** между темами различных уровней
3. **Визуальное представление** знаний в интерактивном интерфейсе

Главные компоненты системы:

- **Словарь тем** - хранилище всех выявленных тем с их метаданными
- **Тематический Граф** - DAG-структура, отражающая отношения между темами
- **База данных чанков** - коллекция фрагментов текста с их эмбеддингами
- **Система Poincaré Embeddings** - представление узлов графа в гиперболическом пространстве
- **Двухрежимная визуализация** - объективный и субъективный режимы отображения графа

## 2. Структура Тематического Графа

### 2.1 Концепция направленного ациклического графа (DAG)

DAG — это тип графа, где:

- Связи имеют направление (от родителя к потомку)
- Невозможно, двигаясь по направлению связей, вернуться в исходную точку (отсутствие циклов)

DAG идеально подходит для моделирования иерархических структур, так как позволяет:

- Представлять вложенность (тема → подтема → под-подтема)
- Поддерживать множественное наследование (тема может иметь несколько родителей)
- Эффективно отслеживать все пути в иерархии через топологическую сортировку

### 2.2 Сущности Тематического Графа

#### 2.2.1 Словарь тем

Центральное хранилище всех тем, обнаруженных в корпусе знаний:

```json
{
  "id": "theme_42",
  "label": "Астрономия",
  "type": "manual",  // или "discovered"
  "source": "Astronomy.md",
  "embedding": [...],  // Евклидов эмбеддинг
  "poincare_embedding": [...],  // Гиперболический эмбеддинг
  "confidence": 0.95,  // для неявных тем
  "linked_chunks": ["chunk_15", "chunk_16", ...],
  "metadata": {
    "creation_date": "2024-05-02",
    "last_modified": "2024-05-02",
    "description": "Наука о космических объектах"
  }
}
```

#### 2.2.2 Узлы графа

Узлы графа представляют темы из Словаря тем, но дополнительно хранят информацию о связях:

```json
{
  "id": "theme_42",
  "theme_ref": "theme_42",  // ссылка на соответствующую тему в Словаре
  "parents": ["theme_40", "theme_41"],  // родительские узлы (вертикальные связи вверх)
  "children": ["theme_43", "theme_44"],  // дочерние узлы (вертикальные связи вниз)
  "related": [{  // горизонтальные связи
    "theme_id": "theme_50",
    "relation_type": "related",
    "weight": 0.75
  }],
  "depth": 2,  // глубина в иерархии от корня
  "poincare_coordinates": [0.2, 0.3]  // координаты в диске Пуанкаре (для визуализации)
}
```

#### 2.2.3 База данных чанков

Каждый чанк представляет собой фрагмент текста с метаданными и связями с темами:

```json
{
  "id": "chunk_15",
  "text": "Телескопы — это оптические инструменты для наблюдения удаленных объектов...",
  "embedding": [...],  // векторное представление в евклидовом пространстве
  "source_doc": "Telescopes.md",
  "linked_themes": [{
    "theme_id": "theme_42",
    "weight": 0.83
  }]
}
```

## 3. Типы связей в Тематическом Графе

### 3.1 Вертикальные связи

Вертикальные связи формируют иерархическую структуру графа и представляют отношения вложенности или подчиненности между темами. Каждая вертикальная связь имеет направление от более общей темы (родителя) к более конкретной (потомку).

**Типы вертикальных связей:**

1. **inclusion** (включение) — тема A полностью включает тему B (A ⊃ B)
2. **part_of** (часть-целое) — тема A является составной частью темы B
3. **specialization** (специализация) — тема A представляет частный случай темы B

**Пример:**

```json
{
  "from": "Астрономия",
  "to": "Наблюдательная астрономия",
  "type": "inclusion",
  "weight": 0.92
}
```

### 3.2 Горизонтальные связи

Горизонтальные связи отражают семантическую близость между темами, которые находятся на одном или разных уровнях иерархии, но не связаны отношениями подчинения.

**Типы горизонтальных связей:**

1. **related** (связанные) — темы имеют смысловую связь
2. **similar** (похожие) — темы близки по смыслу или применению
3. **opposition** (противоположности) — темы являются антонимичными или контрастными
4. **complement** (дополняющие) — темы дополняют друг друга

**Пример:**

```json
{
  "from": "Телескопы",
  "to": "Оптика",
  "type": "related",
  "weight": 0.76
}
```

## 4. Процесс построения Тематического Графа

Построение Тематического Графа происходит в несколько этапов, каждый из которых имеет свои входные и выходные данные, а также технологический стек для реализации.

### 4.1 Выявление тем и построение Словаря тем

#### Входные данные:

- Коллекция документов по предметной области
- Метаданные документов (теги, заголовки, структура)

#### Процесс:

1. **Извлечение явных тем** из заголовков, тегов, метаданных документов
2. **Предварительная векторизация текста** для выявления семантических кластеров
3. **Кластеризация** для обнаружения неявных тем
4. **Наполнение Словаря тем** с метками "manual" для явных и "discovered" для неявных тем

#### Выходные данные:

- Словарь тем с метаданными, но без иерархических связей
- Начальные евклидовы эмбеддинги для каждой темы

#### Технологический стек:

- **Обработка текста**: SpaCy, NLTK
- **Векторизация**: SentenceTransformers
- **Кластеризация**: HDBSCAN
- **Хранение**: MongoDB или PostgreSQL с JSONB

### 4.2 Чанкирование и связывание чанков с темами

#### Входные данные:

- Коллекция документов
- Словарь тем

#### Процесс:

1. **Разбиение документов на чанки** по логическим границам
2. **Векторизация чанков** в евклидовом пространстве
3. **Связывание чанков с темами** по семантической близости
4. **Взвешивание связей** между чанками и темами

#### Выходные данные:

- База данных чанков с эмбеддингами
- Связи между чанками и темами с весами

#### Технологический стек:

- **Чанкирование**: LangChain или собственная логика на Python
- **Векторизация**: SentenceTransformers
- **Индексация**: FAISS или ChromaDB
- **Хранение**: PostgreSQL или специализированные векторные БД (Pinecone, Weaviate)

### 4.3 Построение начальной структуры Тематического Графа

#### Входные данные:

- Словарь тем
- База данных чанков с привязками к темам

#### Процесс:

1. **Анализ общих чанков** между темами для выявления связей
2. **Определение иерархических отношений** по доле пересечения множеств чанков
3. **Построение горизонтальных связей** по семантической близости тем
4. **Проверка графа на ацикличность** и топологическая сортировка

#### Выходные данные:

- DAG-структура с вертикальными и горизонтальными связями
- Взвешенные связи между узлами графа

#### Технологический стек:

- **Работа с графами**: NetworkX
- **Анализ данных**: NumPy, SciPy
- **Хранение графа**: Neo4j или PostgreSQL с расширением для графов

### 4.4 Расчет Poincaré Embeddings для узлов графа

#### Входные данные:

- DAG-структура Тематического Графа
- Вертикальные связи между узлами

#### Процесс:

1. **Подготовка пар** для обучения (родитель-потомок)
2. **Обучение модели Poincaré Embeddings** на данных пар
3. **Назначение координат в гиперболическом пространстве** каждому узлу графа
4. **Валидация качества** полученных эмбеддингов

#### Выходные данные:

- Poincaré-эмбеддинги для каждого узла графа
- Координаты узлов в гиперболическом пространстве для визуализации

#### Технологический стек:

- **Poincaré Embeddings**: HypLL или Gensim
- **Optimization**: PyTorch с geoopt
- **Валидация**: scikit-learn

### 4.5 Уточнение структуры графа на основе Poincaré Embeddings

#### Входные данные:

- Первичная структура графа
- Poincaré Embeddings для узлов

#### Процесс:

1. **Анализ гиперболических расстояний** между узлами
2. **Выявление потенциальных пропущенных связей** или иерархических уровней
3. **Корректировка вертикальных связей** на основе расположения в гиперболическом пространстве
4. **Расчет координат узлов** для визуализации в диске Пуанкаре

#### Выходные данные:

- Уточненная DAG-структура Тематического Графа
- Финальные координаты для визуализации

#### Технологический стек:

- **Анализ гиперболического пространства**: HypLL, geomstats
- **Работа с графами**: NetworkX
- **Визуализация**: D3.js или Cytoscape.js

## 5. Технология Poincaré Embeddings

### 5.1 Основы гиперболической геометрии

Гиперболическая геометрия — это неевклидова геометрия с постоянной отрицательной кривизной. В отличие от евклидова пространства, в гиперболическом пространстве:

- Объем растет экспоненциально с увеличением радиуса
- Через точку вне прямой проходит бесконечно много параллельных прямых
- Сумма углов треугольника меньше 180 градусов

Эти свойства делают гиперболическое пространство идеальным для моделирования иерархических структур, так как оно предоставляет "больше места" по мере удаления от центра.

### 5.2 Модель диска Пуанкаре

Диск Пуанкаре — это модель двумерного гиперболического пространства, представленная как единичный круг в евклидовой плоскости, где:

- Весь бесконечный гиперболический план отображается внутри единичного круга
- Прямые линии в гиперболическом пространстве отображаются как дуги окружностей, перпендикулярные к границе диска
- Расстояние между точками увеличивается экспоненциально при приближении к границе диска

**Формула гиперболического расстояния в диске Пуанкаре:**

```
d(u, v) = arccosh(1 + 2 * ||u - v||² / ((1 - ||u||²) * (1 - ||v||²)))
```

где `||u||` — евклидова норма точки u.

### 5.3 Процесс обучения Poincaré Embeddings

#### 5.3.1 Входные данные для обучения

Обучение Poincaré Embeddings требует набора пар узлов, связанных иерархическими отношениями:

```
(родитель1, потомок1)
(родитель1, потомок2)
(родитель2, потомок3)
...
```

#### 5.3.2 Функция потерь

Функция потерь минимизирует расстояние между связанными узлами и максимизирует расстояние между несвязанными:

```
L = -log( exp(-d(u,v)) / sum(exp(-d(u,n))) )
```

где:

- d(u,v) — гиперболическое расстояние между связанными узлами
- n — отрицательные примеры (несвязанные узлы)

#### 5.3.3 Процесс оптимизации

Оптимизация в гиперболическом пространстве требует специальных методов:

1. **Инициализация векторов** близко к началу координат (но не в самом центре)
2. **Фаза "burn-in"** с пониженной скоростью обучения для лучшей начальной организации
3. **Римановский градиентный спуск** вместо обычного градиентного спуска
4. **Проекция векторов** после каждого шага для сохранения их в пределах диска Пуанкаре

#### 5.3.4 Интерпретация Poincaré Embeddings

После обучения:

- Узлы ближе к центру соответствуют более общим концепциям
- Узлы ближе к границе диска соответствуют более специфичным концепциям
- Узлы, близкие друг к другу, имеют семантическое сходство в иерархическом контексте

### 5.4 Интеграция с евклидовыми эмбеддингами

Наш гибридный подход предполагает использование как евклидовых, так и гиперболических эмбеддингов:

1. **Хранение обоих типов эмбеддингов** для каждой темы
2. **Евклидовы эмбеддинги** для семантического поиска и задач классификации
3. **Poincaré Embeddings** для иерархической навигации и визуализации
4. **Проекции между пространствами** при необходимости:

```python
def poincare_to_euclidean(point, manifold):
    # Логарифмическое отображение из диска Пуанкаре в касательное пространство
    return manifold.logmap0(point)

def euclidean_to_poincare(point, manifold):
    # Экспоненциальное отображение из касательного пространства в диск Пуанкаре
    return manifold.expmap0(point)
```

## 6. Визуализация Тематического Графа

### 6.1 Объективный режим

В объективном режиме граф представлен как макроструктура с корневой темой в центре, что обеспечивает глобальный взгляд на всю иерархию.

#### 6.1.1 Особенности визуализации

- **Радиальная структура** — корневая тема в центре, темы первого уровня вокруг неё
- **Кластеризация по вертикальным связям** — тематические группы выделяются визуально
- **Адаптивное масштабирование** — при увеличении масштаба кластеры разворачиваются
- **Уровни детализации (LOD)** — разная детализация на разных уровнях масштаба

#### 6.1.2 Алгоритмы кластеризации

- **Modularity-Based Clustering** — для выявления тематических сообществ
- **Hierarchical Edge Bundling** — для уменьшения визуальной сложности связей
- **Force-Directed Layout** — для естественного размещения узлов с учетом их связей

### 6.2 Субъективный режим (модель диска Пуанкаре)

В субъективном режиме используется гиперболическая геометрия и модель диска Пуанкаре, создающая эффект "рыбьего глаза" — выбранная тема находится в фокусе, а связанные темы располагаются вокруг.

#### 6.2.1 Особенности гиперболической визуализации

- **Фокус+Контекст** — центральная тема отображается в деталях, сохраняя контекст
- **Бесконечное пространство в конечной области** — весь граф в пределах диска
- **Экспоненциальное расширение** — площадь растет экспоненциально от центра
- **Преобразования Мёбиуса** — для плавной навигации между узлами

#### 6.2.2 Техническая реализация

- **Проективное отображение** — гиперболическая плоскость проецируется на диск Пуанкаре
- **Изогнутые дуги** — связи отображаются как геодезические линии
- **Динамический пересчет координат** — при смене фокуса весь граф трансформируется

### 6.3 Интерфейсные элементы

#### 6.3.1 Хлебные крошки (breadcrumb)

- Показывают путь от текущей темы к корню графа
- Позволяют быстро перемещаться между уровнями иерархии

#### 6.3.2 Панель контекста темы

- Отображает метаданные выбранной темы
- Показывает связанные документы и чанки
- Предоставляет информацию о родительских и дочерних связях

#### 6.3.3 Элементы управления визуализацией

- Переключение между объективным и субъективным режимами
- Кнопка "Сделать центром" для субъективного режима
- Ползунки для контроля уровня детализации
- Фильтры по типам связей и категориям тем

#### 6.3.4 Визуальное кодирование

- **Цвет** — тип темы или категория
- **Размер** — важность темы или количество связанных чанков
- **Яркость** — выделение активной темы и ближайших связей
- **Толщина линий** — сила связи между темами

## 7. Технологический стек для реализации

### 7.1 Базовая инфраструктура

- **Язык программирования**: Python 3.10+
- **Управление зависимостями**: Poetry или Conda
- **Версионирование**: Git
- **CI/CD**: GitHub Actions или GitLab CI

### 7.2 Обработка и анализ данных

- **Обработка текста**: SpaCy, NLTK
- **Векторизация**: SentenceTransformers
- **Анализ данных**: NumPy, SciPy, Pandas
- **Машинное обучение**: scikit-learn

### 7.3 Работа с графами и эмбеддингами

- **Графовые алгоритмы**: NetworkX
- **Векторные базы данных**: FAISS или ChromaDB
- **Гиперболические эмбеддинги**: HypLL или Gensim
- **Римановская оптимизация**: geoopt (расширение PyTorch)
- **Гиперболическая геометрия**: geomstats

### 7.4 Хранение данных

- **Основная БД**: PostgreSQL с JSONB или MongoDB
- **Графовая БД**: Neo4j (опционально)
- **Векторное хранилище**: Pinecone, Weaviate или внутренняя реализация

### 7.5 Визуализация и интерфейс

- **Базовая визуализация**: Matplotlib, Plotly
- **Интерактивная визуализация**: D3.js или Cytoscape.js
- **Фронтенд**: React или Vue.js
- **Компоненты интерфейса**: Tailwind CSS, Material UI или собственный дизайн-система

## 8. Преимущества и ограничения подхода

### 8.1 Преимущества

1. **Эффективное представление иерархий**
    
    - Гиперболическое пространство естественно моделирует иерархические структуры
    - Требуется меньшая размерность для представления сложных иерархий
2. **Интуитивная визуализация**
    
    - Эффект "рыбьего глаза" для фокуса и контекста
    - Наглядное представление иерархических отношений
3. **Гибридный подход**
    
    - Сохранение преимуществ евклидовых эмбеддингов для семантического поиска
    - Использование Poincaré Embeddings для иерархической навигации
    - Возможность проекций между пространствами
4. **Масштабируемость**
    
    - Экспоненциальный рост пространства позволяет эффективно моделировать большие иерархии
    - Многоуровневые подходы к визуализации обеспечивают работу с большими графами

### 8.2 Ограничения

1. **Сложность оптимизации**
    
    - Обучение в гиперболическом пространстве требует специальных методов
    - Риск численной нестабильности при приближении к границе диска
2. **Интерпретация расстояний**
    
    - Интуитивное понимание гиперболических расстояний требует привыкания
    - Визуальное и фактическое расстояние могут сильно различаться
3. **Ограничения для некоторых типов графов**
    
    - Не все графы естественно вкладываются в гиперболическое пространство
    - Графы с низкой иерархичностью могут не получить существенных преимуществ
4. **Технические ограничения**
    
    - Требуется специализированные библиотеки и навыки
    - Более высокие вычислительные требования по сравнению с евклидовыми методами

## 9. Заключение

Тематический Граф с интеграцией Poincaré Embeddings представляет собой мощный инструмент для организации, навигации и визуализации знаний. Комбинируя традиционные методы представления знаний с инновационными подходами гиперболической геометрии, мы получаем систему, способную эффективно моделировать как семантические отношения, так и сложные иерархические структуры.

Предложенная методология охватывает весь процесс от извлечения тем из корпуса документов до интерактивной визуализации знаний, предоставляя как технические детали реализации, так и концептуальные основы подхода. Гибридная природа системы позволяет извлекать максимум преимуществ из обоих типов геометрических пространств, создавая гибкий и мощный инструмент для работы со знаниями.

По мере дальнейшего развития Тематического Графа планируется расширение его функциональности, интеграция с генеративными моделями и совершенствование алгоритмов для более точного моделирования предметных областей.