# Тематический граф

## Назначение

Определяет иерархическую карту знаний, связывая тематические области (Темы) между собой и с текстовыми чанками.

## Структура графа

### Метаданные узлов (Тем)

|Поле|Описание|
|---|---|
|`id`|Канонический ключ темы (нормализованный)|
|`title`|Читаемое имя / заголовок|
|`summary`|Краткое определение темы (до ~300 симв.)|
|`definition_doc`|Ссылка на Markdown-документ с подробным описанием (может быть `null`, если статьи пока нет)|
|`exists`|`true/false` — есть ли статья-определение|
|`aliases`|Список синонимов / альтернативных названий|
|`tags`|Связанные хэштеги|
|`embedding_primary`|Главный эмбеддинг темы (Sentence-Transformer)|
|`embeddings_extra`|Доп. эмбеддинги при необходимости (например, исторический, технический и т.д.)|
|`docs_count`|Кол-во документов, напрямую связанных с темой|
|`chunks_count`|Кол-во чанков, привязанных к теме|
|`pagerank`|Вес узла, вычисленный на графе (page-rank)|

### Типы рёбер между Темами

|Тип|Направление|Значение веса|Назначение|
|---|---|---|---|
|`proximity`|двустороннее|0-1|Семантическая близость (чем больше, тем ближе)|
|`opposite`|двустороннее|0-1|Противоположность понятий|
|`complements`|двустороннее|0-1|Темы дополняют друг друга|
|`includes`|A → B|0-1|A включает B (родитель-потомок)|
|`partially_overlaps`|двустороннее|0-1|Темы частично перекрываются|
|`depends_on`|A → B|0-1|A зависит от B|
|`causes`|A → B|0-1|A является причиной B|
|`precedes`|A → B|0-1|A предшествует B во времени|
|`follows`|A → B|0-1|A следует за B во времени|
|`exemplifies`|A → B|0-1|A является примером B|
|`symbolizes`|A → B|0-1|A символизирует B|

### Метаданные чанков

|Поле|Описание|
|---|---|
|`id`|Уникальный идентификатор чанка|
|`text`|Текстовое содержание чанка|
|`source`|Исходный Markdown-документ|
|`position`|Позиция чанка в исходном документе (начало и конец)|
|`theme_weights`|Ассоциации чанка с темами и веса этих ассоциаций (от 0 до 1)|
|`embedding`|Эмбеддинг чанка (Sentence-Transformer)|
|`tags`|Список тегов, извлеченных из чанка|
|`terms`|Список ключевых терминов из чанка|

## Структура данных (JSON)

Темы и связи, а также связанные с ними чанки хранятся в виде JSON, в двух отдельных массивах:

```json
{
  "themes": [
    {
      "id": "quantum_mechanics",
      "title": "Квантовая механика",
      "summary": "Раздел физики, изучающий поведение материи и энергии на квантовом уровне.",
      "definition_doc": "quantum_mechanics.md",
      "exists": true,
      "aliases": ["квантовая физика"],
      "tags": ["physics", "quantum"],
      "embedding_primary": [0.01, 0.23, ...],
      "embeddings_extra": [],
      "docs_count": 10,
      "chunks_count": 40,
      "pagerank": 0.78
    }
  ],
  "edges": [
    {
      "source": "quantum_mechanics",
      "target": "probability_theory",
      "type": "depends_on",
      "weight": 0.9
    },
    {
      "source": "modernism",
      "target": "postmodernism",
      "type": "precedes",
      "weight": 0.85
    }
  ],
  "chunks": [
    {
      "id": "chunk_1",
      "text": "Основные понятия квантовой механики включают неопределённость и суперпозицию состояний.",
      "source": "quantum_mechanics.md",
      "position": {"start": 0, "end": 120},
      "theme_weights": {"quantum_mechanics": 0.95, "probability_theory": 0.75},
      "embedding": [0.12, 0.34, ...],
      "tags": ["quantum", "physics"],
      "terms": ["неопределённость", "суперпозиция"]
    }
  ]
}
```

## Этапы построения

1. **Инициализация Тем** (до чанкирования)
    
2. **Привязка чанков** (во время чанкирования)
    
3. **Уточнение весов** (после чанкирования)
    

## Использование

- Улучшенный поиск (двухуровневый)
    
- Визуальная навигация (граф интерфейса)
    
- Поддержка Аналитика и Ученика
    

## API (проект)

```python
class ThematicGraph:
    def build_initial(path): ...
    def attach_chunk(chunk): ...
    def finalize(): ...
```

## Будущие расширения

- Слой мета-тем
    
- Типизированные отношения (depends, contradicts, includes)
    
- Машинное обучение на графе
    

### Режимы визуализации

1. **Объективный («Карта»)**
    
    - Force-layout по слою `proximity`
        
    - Тема, принадлежащая нескольким кластерам, дублируется;
        
    - Дубликаты соединены пунктирной «телепорт-линией» и имеют один `master-id`.
        
2. **Субъективный («Фокус»)**
    
    - Щёлкнутый узел = центр.
        
    - Соседние темы радикально перераспределяются по расстоянию _∝ 1/proximity_.
        
    - Направление задаётся типом связи (`includes` ↑, `opposite` ↓ …).
        
    - Остальные узлы постепенно скрываются (fade).
        

_Переключатель режимов_ встроен в панель инструментов графа.

Визуализация поддерживает «масштаб», при котором близкие темы могут автоматически группироваться и разделяться для более удобного восприятия.