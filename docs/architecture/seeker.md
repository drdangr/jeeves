# Стратегия построения Тематического Графа и Словаря Тем для Jeeves

## Введение

Мы строим смысловую карту знаний, в которой каждая тема, идея и фрагмент текста становятся узлами единой живой структуры. Это не просто база данных — это основа мышления и коммуникации внутри ассистента Дживса. Тематический Граф становится ядром, на которое опираются:

- обработка и хранение знаний;
    
- работа субличностей (Seeker, Learner, Analyst);
    
- навигация и генерация текстов;
    
- визуальный и когнитивный интерфейс.
    

### Почему DAG (направленный ациклический граф)?

- Он позволяет иметь **множественные родительские и дочерние связи** (в отличие от деревьев)
    
- Он даёт возможность строить **иерархии смыслов** без циклов и конфликтов
    
- Он масштабируется без потери структуры и может визуализироваться как **плоско**, так и **в гиперболическом пространстве**
    
- Он поддерживает **динамическую глубину**, что позволяет пользователю ориентироваться как по ширине, так и по смысловой глубине
    

### Пример DAG-графа тем

```
Астрономия
├── Небесные тела
│   ├── Планеты
│   └── Звёзды
├── Наблюдательная астрономия
│   ├── Телескопы
│   └── Обсерватории
└── Космология
    └── Теория Большого взрыва
```

Здесь видно:

- У "Астрономии" — три основные ветви
    
- "Телескопы" вложено в "Наблюдательная астрономия"
    
- "Планеты" и "Звёзды" — дочерние темы "Небесные тела"
    

Эта структура:

- помогает анализировать глубину понятий
    
- позволяет визуализировать вложенность и соседство
    
- становится отправной точкой для поиска, вывода гипотез, генерации текста и подсказок Learner
    

Мы проектируем живую, развивающуюся структуру знаний, которая позволит Jeeves эффективно оперировать понятиями, документами, смысловыми связями и знаниями пользователя. В основе этой системы лежит **Тематический Граф** — сеть, построенная на принципах:

- **DAG (направленный ациклический граф)** — чтобы поддерживать вложенность, множественное наследование и смысловую иерархию
    
- **Мультипроходной архитектуры** — пошагового сбора, привязки, анализа и уточнения
    
- **Гиперболической визуализации (Poincaré-диск)** — для компактного и масштабируемого отображения структуры
    
- **Смены центра перспективы (объективный/субъективный режим)** — как основа интерфейса и мышления
    
- **Влияния на субличности Jeeves** — граф становится ядром, с которым работают модули Seeker, Learner, Analyst
    

---

## Шаг 1. Выявление тем и построение узлов

Все обнаруженные и созданные темы формируют так называемый **Словарь Тем** — централизованную структуру, в которой для каждой темы сохраняется её идентификатор, тип, источник, метаданные, связи и связанные чанки. Этот словарь:

- сохраняется в отдельном файле (или базе) и связан с Тематическим Графом;
    
- используется всеми модулями Дживса как основа для поиска, генерации и анализа;
    
- может быть обновлён автоматически или вручную при правке темы;
    
- является основой навигации и визуализации, предоставляя унифицированный доступ к понятийному содержанию знаний.
    

### A. Явные (ручные) темы

- Извлекаются из .md-документов, заголовков, ссылок, тегов
    
- Каждая такая тема становится узлом графа с типом `manual`
    

### B. Неявные темы

- Выявляются на основе эмбедингов чанков и анализа их смыслового сходства
    
- Такие темы создаются автоматически и сохраняются как темы типа `discovered`
    
- В метаданных темы указывается её происхождение, степень уверенности алгоритма и связанные чанки
    
- Для неподтвержденных тем можно использовать дополнительные атрибуты в метаданных:
    
    ```json
    {
      "confidence": 0.75,  // степень уверенности в теме
      "status": "pending_review"  // флаг для Learner
    }
    ```
    

### Алгоритм выявления неявных тем:

1. **Кластеризация эмбеддингов чанков** с помощью HDBSCAN
2. **Выделение устойчивых кластеров** с силуэтным коэффициентом > 0.5
3. **Создание узлов-тем** для каждого выделенного кластера
4. **Взаимодействие с Learner** для запроса уточнения у пользователя

#### Пример структуры узла темы:

```json
{
  "id": "theme_42",
  "label": "Наблюдательная астрономия",
  "type": "manual",
  "source": "Astronomy.md",
  "embedding": [...],
  "chunks": ["chunk_15", "chunk_16"],
  "parents": ["Астрономия"],
  "children": ["Телескопы", "Обсерватории"],
  "related": ["Физика оптических явлений"]
}
```

---

## Шаг 2. Чанкинг и структура данных

- Документы нарезаются на чанки по логическим и смысловым границам (см. ссылка на документ по чанкингу)
    
- Каждый чанк получает эмбединг (векторное представление смысла)
    
- Привязка чанков к темам осуществляется по ссылкам, тегам и близости эмбедингов
    

#### Пример структуры чанка:

```json
{
  "id": "chunk_15",
  "text": "Телескопы — это оптические инструменты, используемые для наблюдения удаленных объектов...",
  "embedding": [...],
  "source_doc": "Telescopes.md",
  "linked_themes": ["Телескопы", "Наблюдательная астрономия"]
}
```

---

## Шаг 3. Построение связей

Тематический Граф — это не просто набор тем и чанков, а прежде всего сеть их взаимосвязей. Связи между узлами делятся на два основных типа, каждый со своим набором конкретных типов связей.

### Типы связей:

#### 1. Горизонтальные связи

- Отражают **смысловую близость** тем
    
- Строятся на основе **косинусной близости эмбедингов** тем
    
- Часто связывают темы одного уровня или смежных категорий
    
- Включают следующие конкретные типы:
    
    - `related` - простая смысловая связанность
    - `similar` - высокая степень сходства
    - `opposition` - противоположность/противостояние
    - `complement` - взаимодополняемость

##### Пример:

```json
{
  "from": "Телескопы",
  "to": "Оптика",
  "type": "related",
  "weight": 0.76
}
```

#### 2. Вертикальные связи (иерархия)

- Отражают отношение **вложенности** или **включения**
    
- Формируют основу DAG-структуры
    
- Включают следующие конкретные типы:
    
    - `inclusion` - полное включение (A ⊂ B)
    - `part_of` - часть целого
    - `specialization` - конкретизация общего понятия
- Строятся по совокупности критериев:
    
    - Доля пересекающихся чанков (`overlap = |A ∩ B| / |A|`)
        
    - Косинусная близость эмбедингов тем
        
    - Размер и плотность тем (например, тема B шире и охватывает больше чанков)
        
    - Контекстные метки и ссылки
        
- Используются для построения иерархии DAG и расчёта глубины
    

##### Пример вертикальной связи:

```json
{
  "from": "Телескопы",
  "to": "Наблюдательная астрономия",
  "type": "inclusion",
  "weight": 0.91
}
```

### Роль DAG в онтологической геометрии знаний

DAG предоставляет идеальный инструмент для моделирования сложных иерархических отношений:

1. **Поддержка множественного наследования** - узел может иметь несколько родителей
2. **Исключение циклов** - логически противоречивые связи исключаются
3. **Алгоритмическая эффективность** - поддерживает топологическую сортировку и эффективный поиск
4. **Естественное отображение сложности знаний** - моделирует полииерархию и взаимосвязи между разными ветвями

#### Алгоритм поддержания DAG-структуры:

```python
def add_vertical_edge(graph, from_node, to_node, edge_type, weight):
    # Добавить связь временно
    graph.add_edge(from_node, to_node, type=edge_type, weight=weight)
    
    # Проверить на циклы
    if has_cycle(graph):
        # Удалить связь, если она создает цикл
        graph.remove_edge(from_node, to_node)
        return False
    
    return True
```

---

## Шаг 4. Динамическое смещение центра графа (режимы перспективы)

Тематический Граф поддерживает два режима навигации:

### Объективный режим

- Центр гиперболической визуализации зафиксирован на корневой теме (например, "Астрономия")
    
- Показываются все узлы и связи по мере удаления от центра
    
- Полезен для анализа общей структуры, визуального картографирования знаний
    

### Субъективный режим

- Центр графа переносится на выбранную пользователем тему
    
- Граф пересчитывается: ближайшие — вложенные и родственные темы, дальние — контекст
    
- Полезен для исследования, генерации знаний, обнаружения лакун и гипотез Learner
    

> Переход между режимами меняет как визуальную перспективу, так и фокус аналитических запросов

---

## Шаг 5. Визуализация и интерфейс

Тематический Граф визуализируется в двух основных режимах, обеспечивающих разные подходы к исследованию знаний: объективный и субъективный.

### Объективный режим

В этом режиме граф представлен как макроструктура, с корневой нодой (например, "Астрономия") в центре. Этот режим обеспечивает глобальный взгляд на всю иерархию знаний.

#### Особенности визуализации:

- **Радиальная структура** — корневая нода в центре, темы первого уровня вокруг нее, и так далее
- **Кластеризация по вертикальным связям** — темы группируются в визуальные кластеры на основе вертикальных связей
- **Адаптивное масштабирование** — при увеличении масштаба кластеры разворачиваются, показывая подтемы
- **Уровни детализации (LOD)** — на разных уровнях масштабирования показывается разное количество информации

#### Алгоритмы кластеризации:

- **Modularity-Based Clustering** — для выявления тематических сообществ
- **Hierarchical Edge Bundling** — для уменьшения визуальной сложности связей между узлами
- **Force-Directed Layout** — для естественного размещения нод с учетом их связей

### Субъективный режим (модель диска Пуанкаре)

В этом режиме используется гиперболическая геометрия и модель диска Пуанкаре, создающая эффект "рыбьего глаза" - выбранная тема находится в фокусе в центре диска, а связанные темы располагаются вокруг нее с уменьшением размера к краям.

#### Особенности гиперболической визуализации:

- **Фокус+Контекст** — центральная тема отображается в деталях, при этом сохраняется видимость общего контекста
- **Бесконечное пространство в конечной области** — гиперболическая геометрия позволяет отображать бесконечное пространство в круге конечного размера
- **Экспоненциальное расширение пространства** — площадь растет экспоненциально от центра, что идеально подходит для иерархических структур
- **Преобразования Мёбиуса** — для плавной навигации между узлами, создающей эффект "путешествия" по графу знаний

#### Техническая реализация:

- **Проективное отображение** — гиперболическая плоскость проецируется на диск Пуанкаре
- **Изогнутые дуги** — связи отображаются как геодезические линии в гиперболическом пространстве
- **Динамический пересчет координат** — при смене фокуса весь граф плавно трансформируется

### Интерфейсные элементы

#### Хлебные крошки (breadcrumb)

- Показывают путь от текущей темы к корню графа (например: `Астрономия > Наблюдательная астрономия > Телескопы`)
- Позволяют быстро перемещаться между уровнями иерархии

#### Панель контекста темы

- Отображает метаданные выбранной темы:
    - Название, тип (ручная/обнаруженная)
    - Краткое описание
    - Связанные документы и чанки
    - Родительские и дочерние связи

#### Элементы управления визуализацией

- Переключение между объективным и субъективным режимами
- Кнопка "Сделать центром" для перемещения выбранной темы в центр (в субъективном режиме)
- Ползунки для контроля уровня детализации и степени кластеризации
- Фильтры по типам связей и категориям тем

#### Визуальное кодирование

- **Цвет** — для обозначения типа темы или категории
- **Размер** — отражает важность темы или количество связанных чанков
- **Яркость/контрастность** — выделяет активную тему и ближайшие связи
- **Толщина линий** — показывает силу связи между темами

---

## Интеграция с субличностями Jeeves

Тематический граф является ядром, с которым взаимодействуют все субличности Jeeves, каждая со своими специфическими задачами:

### Seeker (🔍)

- Использует граф для расширения поиска по близким темам
- При поиске по конкретной теме автоматически включает дочерние в результаты
- Указывает "путь по графу" к найденной информации
- Применяет вертикальные связи для поиска от общего к частному

### Analyst (🧠)

- Анализирует структуру графа для выявления противоречий или неполной информации
- Использует вертикальные связи для построения объяснений "от общего к частному"
- Создаёт временные "рабочие" темы для анализа сложных запросов
- Оценивает силу связей при формировании ответов

### Learner (❓)

- Предлагает новые связи на основе пользовательского взаимодействия
- Работает с неподтвержденными темами, запрашивая уточнения
- Отслеживает, какие части графа используются редко или противоречиво
- Выявляет пробелы в знаниях и предлагает их заполнение

---

## Технический стек реализации

Для эффективной реализации Тематического Графа рекомендуется следующий технологический стек:

### Хранение данных:

- **Neo4j** или **PostgreSQL с JSONB** для хранения графа и метаданных
- **FAISS/ChromaDB** для векторного поиска по эмбеддингам

### Обработка данных:

- **SentenceTransformers** для генерации эмбеддингов
- **HDBSCAN** для кластеризации и выявления неявных тем
- **NetworkX** для алгоритмической работы с графами

### Визуализация:

- **D3.js** или **Cytoscape.js** для интерактивного отображения графа
- **React** для построения интерфейса и панелей управления

---

## Метрики качества графа

Для оценки качества тематического графа используются следующие метрики:

1. **Полнота покрытия**: % чанков, привязанных хотя бы к одной теме
2. **Степень связности**: среднее количество связей на один узел
3. **Глубина иерархии**: максимальное количество уровней вложенности
4. **Баланс ветвей**: отношение стандартного отклонения количества дочерних тем к среднему
5. **Доля ручных тем**: % тем, созданных вручную vs. автоматически обнаруженных

Эти метрики отображаются в панели администратора и используются для рекомендаций по улучшению графа. Они также служат индикаторами для Learner, помогая определить, где требуются уточнения.

---

## Дополнительные возможности

1. **Архивация и версионирование**: хранение истории изменений графа для отслеживания эволюции знаний
2. **Выявление лакун знаний**: анализ областей графа с низкой связностью или недостаточным покрытием чанками
3. **Пакетный импорт/экспорт**: возможность сериализации графа для переноса или бэкапа
4. **Коллаборативное редактирование**: возможность совместной работы над графом для команды

---

## Заключение

Эта архитектура делает Тематический Граф не только основой навигации и генерации знаний, но и ключевым источником **поведенческих стратегий Дживса**, структурируя взаимодействие между Seeker, Analyst и Learner.

Тематический граф представляет собой живую, развивающуюся структуру, которая отражает не только содержание знаний, но и их организацию, взаимосвязи и иерархию. Это позволяет Jeeves не просто находить информацию, но понимать её место в общей системе знаний, что критически важно для формирования осмысленных ответов и генерации новых гипотез.